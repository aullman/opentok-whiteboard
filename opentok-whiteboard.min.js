/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *  
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(o,e){return{restrict:"E",template:'<canvas></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="erase()" ng-class="{OT_erase: true, OT_selected: erasing}" value="Eraser"></input><input type="button" ng-click="capture()" class="OT_capture" value="{{captureText}}"></input><input type="button" ng-click="undo()" class="OT_capture" value="Undo"></input><input type="button" ng-click="redo()" class="OT_capture" value="Redo"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(e,t,n){var a,i,c=t.context.querySelector("canvas"),r=(t.context.querySelector("select"),t.context.querySelector("input"),{dragging:!1}),s=0,u=[],l=[],d=[],p=[],h=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);paper.setup(c),e.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],e.captureText=h?"Email":"Capture",e.strokeCap="round",e.strokeJoin="round",c.width=n.width||t.width(),c.height=n.height||t.height(),a||(a=c.getContext("2d"));var g=function(){paper.project.clear(),paper.view.update()};e.changeColor=function(o){e.color=o["background-color"],e.lineWidth=2,e.erasing=!1},e.changeColor(e.colors[Math.floor(Math.random()*e.colors.length)]),e.clear=function(){g(),o.session&&o.session.signal({type:"otWhiteboard_clear"})},e.erase=function(){e.lineWidth=50,e.erasing=!0},e.capture=function(){h?window.location.href="mailto:?subject=Whiteboard&Body=<img src='"+c.toDataURL("image/png")+"'>":window.open(c.toDataURL("image/png"))},e.undo=function(){if(u.length){var o=u.pop();f(o),l.push(o),y("otWhiteboard_undo",o)}};var f=function(o){o.visible=!1,paper.view.update()};e.redo=function(){if(l.length){var o=l.pop();v(o),u.push(o),y("otWhiteboard_redo",o)}};var m,v=function(o){o.visible=!0,paper.view.update()},b=function(o){window.path.add(o.toX,o.toY),d.push(o)},w=function(o){o.forEach(function(o){b(o),d.push(o)})},k=function(e,t,n){for(var a=t.slice(),i=function(o){o&&TB.error(o)};a.length;){var c=a.splice(0,Math.min(a.length,32)),r={type:e,data:JSON.stringify(c)};n&&(r.to=n),o.session.signal(r,i)}},y=function(e,t){o.session&&(p.push(t),m||(m=setTimeout(function(){k(e,p),p=[],m=null},100)))};angular.element(document).on("keyup",function(o){o.ctrlKey&&(90===o.keyCode&&e.undo(),89===o.keyCode&&e.redo())}),angular.element(c).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend touchcancel",function(n){if("mousemove"!==n.type&&"touchmove"!==n.type||r.dragging){n.preventDefault();var a,i=angular.element(c).offset(),p=c.width/t.width(),h=c.height/t.height(),g=n.offsetX||n.originalEvent.pageX-i.left||n.originalEvent.touches[0].pageX-i.left,f=n.offsetY||n.originalEvent.pageY-i.top||n.originalEvent.touches[0].pageY-i.top,m=g*p,v=f*h,w=e.erasing?"pen":"eraser";switch(n.type){case"mousedown":case"touchstart":r.dragging=!0,r.lastX=m,r.lastY=v,window.path&&(window.path.selected=!1),window.path=new paper.Path,path.strokeColor=e.color,path.strokeWidth=e.lineWidth,path.strokeCap=e.strokeCap,path.strokeJoin=e.strokeJoin,"pen"==w&&(path.blendMode="destination-out"),a=new paper.Point(m,v),path.moveTo(a);break;case"mousemove":case"touchmove":if(g=n.offsetX||n.originalEvent.pageX-i.left||n.originalEvent.touches[0].pageX-i.left,f=n.offsetY||n.originalEvent.pageY-i.top||n.originalEvent.touches[0].pageY-i.top,m=g*p,v=f*h,r.dragging){var k={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:r.lastX,fromY:r.lastY,toX:m,toY:v,mode:w,color:e.color,lineWidth:e.lineWidth,show:1};s++,l=[],b(k),d.push(k),r.lastX=m,r.lastY=v,y("otWhiteboard_update",k)}break;case"touchcancel":case"mouseup":case"touchend":case"mouseout":window.path.smooth(),r.dragging=!1,s&&(a=d.length,u.push(window.path),s=0)}}}),o.session&&o.session.on({"signal:otWhiteboard_update":function(t){t.from.connectionId!==o.session.connection.connectionId&&(w(JSON.parse(t.data)),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_undo":function(t){t.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(t.data).forEach(function(o){f(o)}),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_redo":function(t){t.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(t.data).forEach(function(o){v(o)}),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_history":function(o){i&&i!==o.from.connectionId||(i=o.from.connectionId,w(JSON.parse(o.data)),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_clear":function(e){e.from.connectionId!==o.session.connection.connectionId&&g()},connectionCreated:function(e){d.length>0&&e.connection.connectionId!==o.session.connection.connectionId&&k("otWhiteboard_history",d,e.connection)}})}}}]);